<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }

      #map {
        position: absolute;
        inset: 0;
        touch-action: manipulation;
      }

      /* ðŸ”¹ Popup styling */
      .leaflet-popup-content-wrapper {
        background: #fff;
        color: #000;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .leaflet-popup-content {
        margin: 8px 12px;
        font-size: 14px;
        font-weight: 500;
      }

      .leaflet-popup-tip {
        background: #fff;
      }
      .leaflet-popup {
        margin-bottom: 38px;
        transform: translateY(-10px);
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
      const map = L.map("map", {
        zoomControl: true,
        inertia: true,
      }).setView([17.385, 78.4867], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      let MODE = "picker"; // picker | view
      let pickerMarker = null;
      const markersLayer = L.layerGroup().addTo(map);

      const pinIcon = L.icon({
        iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
        iconSize: [20, 25],
        iconAnchor: [10, 25],
      });

      /* ðŸ”¹ Receive message from React Native */
      document.addEventListener("message", function (event) {
        try {
          const data = JSON.parse(event.data);

          if (data.mode) {
            MODE = data.mode;
            markersLayer.clearLayers();
            if (pickerMarker) {
              map.removeLayer(pickerMarker);
              pickerMarker = null;
            }
          }

          /* ðŸ”¹ VIEW MODE â†’ show markers with popup */
          if (MODE === "view" && Array.isArray(data.points)) {
            markersLayer.clearLayers();

            const latLngs = [];

            data.points.forEach((p) => {
              const latLng = [p.lat, p.lng];
              latLngs.push(latLng);

              const marker = L.marker(latLng, {
                icon: pinIcon,
              }).addTo(markersLayer);

              if (p.label) {
                marker.bindPopup(p.label, {
                  closeButton: false,
                  autoClose: true,
                  closeOnClick: true,
                });
              }
            });

            /* ðŸ”¹ AUTO CENTER MAP */
            if (latLngs.length === 1) {
              map.setView(latLngs[0], 15);
            } else if (latLngs.length > 1) {
              map.fitBounds(latLngs, { padding: [40, 40] });
            }
          }
        } catch (e) {
          console.log("Invalid message", e);
        }
      });

      /* ðŸ”¹ Picker mode click */
      map.on("click", function (e) {
        if (MODE !== "picker") return;

        if (pickerMarker) {
          pickerMarker.setLatLng(e.latlng);
        } else {
          pickerMarker = L.marker(e.latlng, {
            icon: pinIcon,
          }).addTo(map);
        }

        window.ReactNativeWebView.postMessage(
          JSON.stringify({
            lat: e.latlng.lat,
            lng: e.latlng.lng,
          })
        );
      });
    </script>
  </body>
</html>
